name: Build

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

permissions:
    contents: write
    packages: write

jobs:
    build-server:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: true

            - name: Setup .NET 10
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"

            - name: Restore
              run: dotnet restore

            - name: Format check
              run: dotnet format --verify-no-changes --verbosity minimal

            - name: Build
              run: dotnet build --no-restore -c Release

            - name: Test (RestifyServer.Tests)
              run: dotnet run --project RestifyServer.Tests/RestifyServer.Tests.csproj

            - name: Publish
              run: dotnet publish ./RestifyServer/RestifyServer.csproj -c Release -o ./out

            - name: Upload published artifact
              uses: actions/upload-artifact@v4
              with:
                  name: restify-server
                  path: ./out

            - uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - uses: docker/build-push-action@v5
              with:
                  push: true
                  file: ./RestifyServer/Dockerfile
                  tags: ghcr.io/${{ github.repository_owner }}/restify-server:latest

    build-client:
        runs-on: ubuntu-latest
        needs: [build-server]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: true

            - name: Install dependencies
              working-directory: RestifyClient
              run: npm ci

            - name: Build
              working-directory: RestifyClient
              run: npm run build

            - name: Test
              working-directory: RestifyClient
              run: npm run test

            - uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - uses: docker/build-push-action@v5
              with:
                  push: true
                  context: ./RestifyClient
                  file: ./RestifyClient/Dockerfile
                  tags: ghcr.io/${{ github.repository_owner }}/restify-client:latest

    tag-build:
        runs-on: ubuntu-latest
        needs: [build-server, build-client]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  persist-credentials: true

            - name: Tag
              if: github.event_name == 'push'
              run: |
                  VERSION=$(grep -oPm1 "(?<=<AssemblyVersion>)[^<]+" RestifyServer/RestifyServer.csproj || echo "1.0.0")
                  TIMESTAMP=$(date -u +"%Y%m%d.%H%M%S")
                  TAG="v$VERSION-$TIMESTAMP"
                  echo "Tagging commit with: $TAG"
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag "$TAG"
                  git push origin "$TAG"
